<div id="contacts-show">
    <div class="container">
		<%= hidden_field_tag 'hidsellerid', @seller.id, id: "hidsellerid" %>
		
        <div class="campaign-edit-header">
			<h3>加入筹款团队<strong><%= @seller.campaign.title %></strong></h3>
        </div>
		
        <div class="container-box top-section">
			<div class="form-group">
				<div class="step-nav-bar">
					<div id="step_nav_icon_1" class="step-nav-icon"></div>
					<div id="step_nav_icon_2" class="step-nav-icon"></div>
					<div id="step_nav_icon_3" class="step-nav-icon"></div>
					<div id="step_nav_icon_4" class="step-nav-icon"></div>
					<div id="step_nav_icon_5" class="step-nav-icon"></div>
					<div id="step_nav_icon_6" class="step-nav-icon step-nav-icon-gray"></div>
					<div id="step_nav_icon_7" class="step-nav-icon"></div>
					<div id="step_nav_icon_8" class="step-nav-icon"></div>
				</div>
			</div>
			
			<div class="form-group">
				<div class="step-title-container">
					<label>Help Promote the Fundraiser</label>&nbsp;&nbsp;<span class="seller-step-qa-icon" style="margin-bottom:6px;">?</span>
				</div>
			</div>
			
			<div id="search-contacts-box" class="search-contacts-box">
				<div class="row header">
					<div class="col-md-12">
						<h4>Import Your Contacts</h4>
					</div>
				</div>
	        	<div>
					<h5>Search your address book for friends</h5>
				</div>
				<div class="row item">
					<div class="col-md-9">
						<div>
							<a href="/contacts/gmail" class="oauth show_tooltip" data-title="Gmail" disabled="disabled">
								<%= image_tag "gmail-icon.png", class: "contacts-icon" %>
							</a>									
							<a href="/contacts/hotmail" class="oauth show_tooltip" data-title="Windows Live/Hotmail/Outlook" disabled="disabled">
								<%= image_tag "outlook-icon.png", class: "contacts-icon" %>
							</a>
							<a href="/contacts/yahoo" class="oauth show_tooltip" data-title="Yahoo" disabled="disabled">
								<%= image_tag "yahoo-icon.png", class: "contacts-icon" %>
							</a>
							<!-- <a href="/contacts/facebook" class="oauth show_tooltip" data-title="Facebook" disabled="disabled">
								<%= image_tag "facebook-icon.png", class: "contacts-icon" %>
							</a> -->
							<!-- <a href="javascript:void(0);" id="btnManualEnterEmail" class="show_tooltip" data-title="Manually Enter Emails" style="display:inline-block; margin:5px 10px;">
								<%= image_tag "edit-icon.png", class: "contacts-icon" %>
							</a> -->
						</div>
					</div>
					<div class="col-md-3" style="display:none;">
						<button id="btnMyContacts" class="btn btn-primary" type="button" style="margin-top:10px; width:100%;">
							<span class="text">My Contacts</span>
						</button>
					</div>
				</div>
	        	<div>
					<p style="padding-top: 10px; font-size: 12px">
						Choosing a service will open a window for you to log in securely and import your contacts to Raisy. You'll only find users who have allowed their accounts to be found by email address. We won't email anyone without your consent.</p>
				</div>
			</div> <!-- search-contacts-box -->
			
			<div id="contacts-result-box" class="contacts-result-box" style="display: none">
				<div class="row header">
					<div class="col-md-12">
						<div>
							<%= image_tag "gmail-icon.png", class: "contacts-icon contacts-icon-gmail", style: "display:none;" %>
							<%= image_tag "yahoo-icon.png", class: "contacts-icon contacts-icon-yahoo", style: "display:none;" %>
							<%= image_tag "outlook-icon.png", class: "contacts-icon contacts-icon-outlook", style: "display:none;" %>
							<%= image_tag "facebook-icon.png", class: "contacts-icon contacts-icon-facebook", style: "display:none;" %>
							&nbsp;<b id="provider_contacts_label" style="font-size:16px;">Contacts</b>&nbsp;&nbsp;&nbsp;
							<a id="btnTryAnotherService" href="javascript:void(0);">
								Back
							</a>
						</div>
						<div class="sub-header">
							<div class="left-col">
								<p>
									Here are <span id="txtContactCount"></span> for you to share your link. You can uncheck "Select all" or anyone you don't want to share.
								</p>
							</div>
							<div class="select-all-box">
								<span>Select all</span>
								<input id="cbxSelectAll" type="checkbox" />
							</div>
						</div>
					</div>
				</div>
				<div id="contacts-item-box">
				</div>
				<div class="footer">
					<div class="send-email-box">
						<a id="btnImportContact" href="javascript:void(0);" class="btn btn-primary" style="width: 200px">
							<span class="text">Import Contacts</span>
							<span class="loader" style="display:none"></span>
						</a>
					</div>
				</div>
			</div> <!-- contacts-result-box -->
			
			<div id="manual-contacts-box" class="manual-contacts-box" style="display: none">
				<div class="row header">
					<div class="col-md-12">
						<div>
							<%= image_tag "edit-icon.png", class: "contacts-icon" %>&nbsp;
							<b style="font-size: 16px">Manually Enter Emails</b>&nbsp;&nbsp;&nbsp;
							<a id="btnTryAnotherServiceManual" href="javascript:void(0);">
								Back
							</a>
						</div>
						<div class="sub-header">
							<div class="left-col">
								<p>
									Enter emails seperated by commas or one per line.
									<br />
									PLEASE NOTE: This will not send email invites.
								</p>
							</div>
						</div>
					</div>
				</div>
				<div id="contacts-item-box">
					<div class="item">
				 		<textarea id="txtManualEmails" name="txtManualEmails" cols="40" rows="5" class="form-control manualemail-textbox"></textarea>
					</div>
				</div>
				<div class="footer" style="padding-top: 0px">
					<a id="btnImportContactManual" href="javascript:void(0);" class="btn btn-primary" style="width: 200px">
						<span class="text">Import Contacts</span>
						<span class="loader" style="display:none"></span>
					</a>
				</div>
			</div>	<!-- manual-contacts-box -->
			
			<div id="contacts-list-box">
				<div style="margin-top:15px;">
					<label style="font-size:18px;">Or Enter Contacts Individually</label>
					&nbsp;&nbsp;&nbsp;
					<!-- <label class="glyphicon glyphicon-plus-sign show_tooltip" data-title="Add Contact" style="cursor:pointer; font-size:22px; vertical-align:top;" onclick="Raisy.users.addNewContactClick();"></label> -->
				</div>
			
				<div style="margin-top:10px; max-height:560px; overflow:auto;">
					<table class="table table-hover contact-table" style="<%= 'display:none;' if @contacts.count==0 %>">
						<thead>
							<tr>
								<th>First Name</th>
								<th>Last Name</th>
								<th><span class="show_tooltip" data-title="What you will call this person in the email (e.g. Grandma)">Greeting&nbsp;&nbsp;<span class="seller-step-qa-icon">?</span></span></th>
								<th>Email</th>
								<th></th>
								<th></th>
								<th></th>
							</tr>
						</thead>
						<tbody class="contact-table-body">
							<% @contacts.order(:id).each do |contact| %>
							<tr class="contact-row">
								<td style="width:160px;">
									<input type="hidden" class="contact-id" value="<%= contact.id %>" />
									<input type="hidden" class="contact-media-id" value="<%= contact.media_id %>" />
								
									<span class="contact-item-text contact-firstname-text"><%= contact.first_name %></span>
									<input type="text" class="form-control contact-update-input contact-firstname-input" value="<%= contact.first_name %>" maxlength="50" placeholder="e.g. John" />
								</td>
								<td style="width:160px;">
									<span class="contact-item-text contact-lastname-text"><%= contact.last_name %></span>
									<input type="text" class="form-control contact-update-input contact-lastname-input" value="<%= contact.last_name %>" maxlength="50" placeholder="e.g. Smith" />
								</td>
								<td style="width:160px;">
									<span class="contact-item-text contact-greetings-text"><%= contact.greetings %></span>
									<input type="text" class="form-control contact-update-input contact-greetings-input" value="<%= contact.greetings %>" maxlength="50" placeholder="e.g. Grandma" />
								</td>
								<td>
									<span class="contact-item-text contact-email-text"><%= contact.email_address %></span>
									<input type="text" class="form-control contact-update-input contact-email-input" value="<%= contact.email_address %>" maxlength="100" style="max-width:100%;" />
								</td>
								<td class="contact-edit-cell contact-ops1-cell"><span class="glyphicon glyphicon-pencil show_tooltip contact-edit-btn" data-title="Edit"></span></td>
								<td class="contact-delete-cell contact-ops1-cell"><span class="glyphicon glyphicon-trash show_tooltip contact-del-btn" data-title="Delete"></span></td>
								<td class="contact-update-cell contact-ops2-cell"><span class="glyphicon glyphicon-ok show_tooltip contact-save-btn" data-title="Save"></span></td>
								<td class="contact-cancel-cell contact-ops2-cell"><span class="glyphicon glyphicon-remove show_tooltip contact-cancel-btn" data-title="Cancel"></span></td>
								<td class="contact-loader-cell"><span class="loader loader-black contact-update-loader" style="visibility:hidden;"></span></td>
							</tr>
							<% end %>
						</tbody>
					</table>
				</div>
			</div>	<!-- contacts-list-box -->
			
			<div style="height:20px;">&nbsp;</div>
			
			<div class="row web-box">
				<div class="col-sm-5 backbutton-box">
					<button class="btn btn-success btn-lg back-btn camp-back-btn-31" type="button" data-currentstep="3.1" onclick="window.location.href='<%= seller_photo_path(@seller) %>';">
						<span class="text">Back</span>
					</button>
				</div>
				<div class="col-sm-3 continuebutton-box">
					<button class="btn btn-success btn-lg skip-btn camp-skip-btn-31" type="button" onclick="window.location.href='<%= seller_sendemails_path(@seller) %>';">
						<span class="text">Skip this step</span>
					</button>
				</div>
				<div class="col-sm-3 continuebutton-box">
					<button class="btn btn-primary btn-lg continue-btn" type="button" data-currentstep="3.1" onclick="window.location.href='<%= seller_sendemails_path(@seller) %>';">
						<span class="text">Continue</span>
					</button>
				</div>
			</div>	<!-- web-box -->
			
			<div class="row mobile-box">
				<div class="col-sm-5 backbutton-box">
					<button class="btn btn-primary btn-lg continue-btn" type="button" data-currentstep="3.1" onclick="window.location.href='<%= seller_sendemails_path(@seller) %>';">
						<span class="text">Continue</span>
					</button>
				</div>
				<div class="col-sm-3 continuebutton-box">
					<button class="btn btn-success btn-lg skip-btn camp-skip-btn-31" type="button" onclick="window.location.href='<%= seller_sendemails_path(@seller) %>';">
						<span class="text">Skip this step</span>
					</button>
				</div>
				<div class="col-sm-3 continuebutton-box">
					<button class="btn btn-success btn-lg back-btn camp-back-btn-31" type="button" data-currentstep="3.1" onclick="window.location.href='<%= seller_photo_path(@seller) %>';">
						<span class="text">Back</span>
					</button>
				</div>
			</div>	<!-- mobile-box -->
			
    	</div>	<!-- container-box -->
		
	</div>	<!-- container -->
	
	<div id="seller_step_tips_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="seller_step_tips_modal" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">

	        <div class="modal-body">
				<p>Easily select which contacts to import from your address book, or select “Enter Contacts Individually” to type in the name and email address of each contact.</p>
				<p>On the next step, you will edit the email that will be sent to these contacts.</p>
				<p>Note: before you send an email, you will be able to select exactly which of your contacts will receive it.</p>
				<span>Tips:</span>
				<ul>
					<li><span>Think of anyone who can help: neighbors, grandparents, friends, aunts and uncles, co-workers, teammates, etc.</span></li>
					<li><span>Don’t be shy! Remember: you are not asking for donations, you are offering products that people know and love!</span></li>
				</ul>
	        </div> <!-- end of modal body -->

	        <div class="modal-footer">
				<div style="position:relative; text-align:center;">
					<button type="button" class="btn btn-default" data-dismiss="modal"><span>Close</span></button>
					<div class="hide_seller_step_tips_container">
						<a id="hide_seller_step_tips" style="cursor:pointer; text-decoration: none;">
							<span style="font-size:12px; font-weight:600;">Don't show this message anymore</span>
						</a>
					</div>
				</div>
	        </div> <!-- /.modal-footer -->
			
	      </div><!-- /.modal-content -->
	    </div><!-- /.modal-dialog -->
	</div>	<!-- seller_step_tips_modal -->
</div>	<!-- contacts-show -->

<script>

	function continue_next_step()
	{
		var ed=tinymce.get("txtEmailBody");
		var $container=$(ed.getContainer());
	
		if (!$container.hasClass("mce-tinymce")) {
			$container=$container.parents(".mce-tinymce").first();
		}
		
		var content=$.trim(ed.getContent({format: "text"}));
		var maxLength=parseInt(ed.getParam("maxlength"));
		var count=maxLength-content.length;
		
		if (count<0) {
			$container.find(".tinymce-charcount span").css("color", "#b94a48").text("Up to "+maxLength+" characters");
			
			//alert("Custom Email Text is too long.");
			
			return;
		}
		
		$container.find(".tinymce-charcount span").css("color", "#00aaff").text(count);
		
		content=$.trim(ed.getContent());
		
		var sellerid = $("#hidsellerid").val();
		
		$.ajax('/ajax/emailcontacts', {
			type: 'POST',
			async: false,
			data: { is_send_email: false, seller_id: sellerid, email_text: content },
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
            },
            success: function(data) {
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            },
			complete: function () {
				window.location.href='<%= seller_sendemails_path(@seller) %>';
			}
		});
	}

	var contacts_list;
	var media_id;	// 1-gmail, 2-yahoo, 3-hotmail, 4-facebook, 5-manual

	$(document).ready(function() {
		
		window.setTimeout(function(){
			<% if @step_popup=="yes" %>
				$("#seller_step_tips_modal").modal("show");
			<% end %>
			
			Raisy.users.addNewContactClick();
		}, 200);
		
				
		$("#cbxSelectAll").click(function(){

			if ($(this).prop("checked")) {
				$(".cbxSelectContact").prop("checked", true);
			} else {
				$(".cbxSelectContact").prop("checked", false);
			}

		});
		
		$("#btnMyContacts").click(function(){

			var sellerid = $("#hidsellerid").val();
			var path = "/seller/mycontacts/" + sellerid;
			var windowName = "SellerMyContacts";
			
			var width = 800;
			var height = 600;
            var left = ($(window).width()  - width)  / 2;
            var top  = ($(window).height() - height) / 2;
			
			var windowOptions = 'scrollbars=1,width=' + width + ',height=' + height + ',left=' + left + 'top=' + top;
			
			window.open(path, windowName, windowOptions);

		});
		
		$(".oauth").click(function(event){
			
			contacts_list = null;
			
			event.preventDefault();

			var path = $(this).attr("href");
			var title = $(this).data("title");
			
			$(".contacts-icon-gmail").hide();
			$(".contacts-icon-yahoo").hide();
			$(".contacts-icon-outlook").hide();
			$(".contacts-icon-facebook").hide();
			$("#provider_contacts_label").text(title + " contacts");
			
			if (title == "Gmail") {
				media_id = 1;
				
				$(".contacts-icon-gmail").show();
			}
			
			if (title == "Yahoo") {
				media_id = 2;
				
				$(".contacts-icon-yahoo").show();
			}
			
			if (title == "Hotmail") {
				media_id = 3;
				
				$(".contacts-icon-outlook").show();
			}
			
			if (title == "Facebook") {
				media_id = 4;
				
				$(".contacts-icon-facebook").show();
			}

			//create new oauthh popup window and monitor it
			
			var width = 520;
			var height = 568;
			var left = ($(window).width()  - width)  / 2;
			var top  = ($(window).height() - height) / 2;
			
			$.oauthpopup({
				path: path,
				windowOptions: 'width=' + width + ',height=' + height + ',left=' + left + 'top=' + top,
				callback: function() {
					
					if (contacts_list != undefined && contacts_list != null) {
						
						var contacts = $.parseJSON(contacts_list);

						if (contacts.length > 0) {
							var contactsHTML = "";
							var contactsCount = 0;

							for (var i = 0; i < contacts.length; i++) {
								
								if (contacts[i].email == null) continue;
								
								contactsCount++;

								var firstName = "";
								var lastName = "";

								if (contacts[i].first_name != null) {
									firstName = contacts[i].first_name;
								}

								if (contacts[i].last_name != null) {
									lastName = contacts[i].last_name;
								}

								contactsHTML += "<div class=\"item\">";
								contactsHTML += 	"<label style=\"width: 30%\">" + contacts[i].name  + "</label>";
								contactsHTML += 	"<span style=\"width: 60%\">" + contacts[i].email  + "</span>";
								contactsHTML += 	"<div class=\"select-box\">";
								contactsHTML += 		"<input type=\"checkbox\" class=\"cbxSelectContact\" email=\"" + contacts[i].email + "\" first_name=\"" + firstName + "\" last_name=\"" + lastName + "\" />";
								contactsHTML += 	"</div>";
								contactsHTML += "</div>";
							}
							
							if (contactsCount==0) {
								window.Raisy.alert("No contact emails found");
							}
							else {
								$("#search-contacts-box").hide();
								$("#contacts-list-box").hide();
								$("#contacts-result-box").show();

								if (contactsCount > 1) {
									$("#txtContactCount").text(contactsCount + " peoples");
								} else {
									$("#txtContactCount").text(contactsCount + " people");
								}

								if (contactsCount >= 10) {
									$("#contacts-item-box").addClass("contacts-item-box");
								}
								
								$("#cbxSelectAll").prop("checked", false);
								$("#contacts-item-box").empty().html(contactsHTML);
							}
								
						} else {

							window.Raisy.alert("No contacts found");

						}

					}

				}
			});

		});
		
		$("#btnManualEnterEmail").click(function(){

			$("#search-contacts-box").hide();
			$("#contacts-list-box").hide();
			$("#manual-contacts-box").show();

		});
		
		$("#btnTryAnotherService").click(function(){

			$("#search-contacts-box").show();
			$("#contacts-list-box").show();
			$("#contacts-result-box").hide();

		});

		$("#btnTryAnotherServiceManual").click(function(){

			$("#search-contacts-box").show();
			$("#contacts-list-box").show();
			$("#manual-contacts-box").hide();

		});
		
		$("#btnImportContact").click(function(){

			var $button = $(this);
			var sellerid = $("#hidsellerid").val();
			var contacts = new Array();
			
			$("input.cbxSelectContact:checked").each(function(index, element){

				var contact = new Object();
				contact.id = "0";
				contact.email_address = $(this).attr("email");
				contact.first_name = $(this).attr("first_name");
				contact.last_name = $(this).attr("last_name");
				contact.media_id = media_id;
				
				contacts.push(contact);

			});

			var error = "";
			if (contacts.length == 0) {
				if (error) error += "<br/>";
				error += "Please select one or more contacts";
			}

			if (error!="") {
				window.Raisy.alert(error);
				return;
			}

	      $button.prop('disabled', true).find('span.text').text('Importing Contacts...').siblings('span.loader').show(200, function() {
	          $.ajax('/ajax/importcontacts', {
	              type: 'POST',
				  data: { contacts: contacts, seller_id: sellerid },
	              beforeSend: function(jqXHR, settings) {
	                  jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
	              },
	              success: function(data) {
					if (data != "failed") {
						window.Raisy.alert("Contacts have been successfully imported");
						
						var ids=data.split(",");
						
						for (var i = 0; i < ids.length; i++) {
							contacts[i].id = ids[i];
						}
				
						Raisy.users.addImportedContactRow(contacts);
				
						$("#search-contacts-box").show();
						$("#contacts-list-box").show();
						$("#contacts-result-box").hide();
					} else {
						window.Raisy.alert("Hmm, there was a problem while importing contacts, please try again.");
					}
	              },
	              error: function(XMLHttpRequest, textStatus, errorThrown) {
					window.Raisy.alert("Hmm, there was a problem while importing contacts, please try again.");
	              },
				  complete: function () {
					$button.prop('disabled', false).find('span.text').text('Import Contacts').siblings('span.loader').hide();
				}
	          });
	      });

		});

		$("#btnImportContactManual").click(function(){

			var $button = $(this);
			var sellerid = $("#hidsellerid").val();
			var contacts = $.trim($("#txtManualEmails").val());

			var error = "";
			var contactsByEnter;
			
			if (contacts.length == 0) {
				
				if (error) error += "\n";
				error += "Please enter one or more contacts.";
				
			} else {

				contactsByEnter = contacts.split("\n");
			
				for (var i = 0; i < contactsByEnter.length; i++) {
				
					var contactsByComma = contactsByEnter[i].split(",");
				
					for (var j = 0; j < contactsByComma.length; j++) {
					
						if (!window.Raisy.valid_email(contactsByComma[j])) {
							if (error) error += "\n";
							error += contactsByComma[j] + " is not a valid email.";
						}
					
					}
				
				}
			}
			
			if (error) {
				alert(error);
				return;
			}

			var manualContacts = new Array();
			
			for (var i = 0; i < contactsByEnter.length; i++) {
				
				var contactsByComma = contactsByEnter[i].split(",");
				
				for (var j = 0; j < contactsByComma.length; j++) {
					
					var contact = new Object();
					contact.email_address = contactsByComma[j];
					contact.first_name = "";
					contact.last_name = "";
					contact.media_id = 5;
				
					manualContacts.push(contact);
					
				}
				
			}
			
      $button.prop('disabled', true).find('span.text').text('Importing Contacts...').siblings('span.loader').show(200, function() {
          $.ajax('/ajax/importcontacts', {
              type: 'POST',
			data: { contacts: manualContacts, seller_id: sellerid },
              beforeSend: function(jqXHR, settings) {
                  jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
              },
              success: function(data) {
				if (data == "success") {
					alert("Contacts have been successfully imported");
				} else {
					alert("Hmm, there was a problem while importing contacts, please try again.");
				}
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
				alert("Hmm, there was a problem while importing contacts, please try again.");
              },
			complete: function () {
				$button.prop('disabled', false).find('span.text').text('Import Contacts').siblings('span.loader').hide();
			}
          });
      });

		});
		
	});
	
</script>