<div id="service_agreement" class="well" style="border-color: rgb(197, 169, 77); margin:-80px 15px 100px; padding: 15px 5px; opacity: 1; background-color: white; display: none;">
  <div style="text-align: right">
    <%= image_tag "arr_right.png", :id => 'btn_view_agreement', :width => 18, :height => 18, :style => "" %>
  </div>
  <%= render "agreement" %>
</div>

  <!--<div class="navbar-fixed-bottom" style="padding:5px 0px 0px 0px; text-align:center;">-->
    <!--&lt;!&ndash; <button id="btn_view_content" type="button" class="btn btn-default" onclick="showContent();" style="border-radius:4px; box-shadow: 1px 1px 1px #888; margin-left:20px; display:none;"><span style="font-size:16px; letter-spacing:1px;">&nbsp;查看原文&nbsp;</span>-->
    <!--</button> &ndash;&gt;-->
    <!--<div style="position:relative; padding-top:0px">-->
      <!--&lt;!&ndash; <div style="position:relative; padding-top:0px; background-color: red; max-width: 750px; margin: 0 auto">-->
      <!--</div> &ndash;&gt;-->
      <!--&lt;!&ndash; <div style="margin:0px auto; text-align:center; width:148px; height:100px;">-->
        <!--<img src="/2016/pay_some.png" style="width:148px; height:100px;" onclick="$('#personal-modal').modal('show');" />-->
      <!--</div> &ndash;&gt;-->
			<!---->
			<!--<div style="padding-bottom:5px; text-align:center;">-->
			  <!--<button id="btn_thanks" type="button" class="btn btn-primary" style="border-radius:4px;">-->
			    <!--<span class="glyphicon glyphicon-heart"></span>&nbsp;&nbsp;<span class="text" style="font-size:16px; letter-spacing:1px;">活动已结束, 感谢您的关注!</span>-->
			  <!--</button>-->
			<!--</div>-->

      <!--<%= hidden_field_tag :fullname, @nickname %>-->
      <!--<%= hidden_field_tag :avatar_url, @avatar_url %>-->
      <!--<%= hidden_field_tag :share_id, @seller ? @seller.id : "" %>-->
    <!--</div>-->
  <!--</div>-->

<%= hidden_field_tag :fullname, @nickname %>
<%= hidden_field_tag :avatar_url, @avatar_url %>

<script language="javascript" type="text/javascript">
  $(function () {
    //展开详情
    var body_scrollTop = 0;
    var indirect_influence_quote_nubmer = 0;
    function showContent() {

      $("#direct_influence").show();
      $("#btn_agreement").show();
      $(".avatar-container").show();
      $("#indirect_influence").show();
      $(".campagin_detail").show();
      // $("#payment_form").show();

      $("#supporters_content").hide();
      $("#btn_view_content").hide();
      $("#service_agreement").hide();
      $("body").scrollTop(body_scrollTop);
    }

    function showSupporters() {
      body_scrollTop = $("body").scrollTop();

      $(".avatar-container").hide();
      $("#indirect_influence").hide();
      $(".campagin_detail").hide();
      // $("#payment_form").hide();

      $("#supporters_content").show();
      $("#btn_view_content").show();
      $("body").scrollTop($("#banner").height());
    }

    function  showAgreement()
    {
      body_scrollTop = $("body").scrollTop();
      $("#direct_influence").hide();
      $("#btn_agreement").hide();
      $("#indirect_influence").hide();
      $(".campagin_detail").hide();

      $("#service_agreement").show();
//      $("#btn_view_agreement").show();
      $("body").scrollTop($("#banner").height());
    }
    $("#btn_view_supporters").click(function () {
      showSupporters();
    });
    $("#btn_agreement").click(function () {
      showAgreement();
    });
    $("#btn_view_agreement").click(function () {
      showContent();
    });
    $("#btn_view_content").click(function () {
      showContent();
    });

    $("img.arri").bind('click', function () {
      var $arri = $("div.arri");
      var $summary = $("div.summary");
      if ($arri.hasClass("arriup")) {
        $arri.removeClass("arriup");
        $summary.addClass("none");
      }
      else {
        $arri.addClass("arriup");
        $summary.removeClass("none");
      }

      // $summary.slideToggle("slow");

    });

    //展示更多
    $("div.more").bind('click', function () {
      alert("展示更多");
      $.ajax({
        type: "post",
        url: "<%= ajax_personal_story_campagin_supporters_path%>",
        data: {},
        success: function (data) {
//          $('#resText').empty();   //清空resText里面的所有内容
          alert(data);
//          $('#resText').html();
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {

        },
        complete: function (XMLHttpRequest, textStatus) {
          this; // 调用本次AJAX请求时传递的options参数
        }
      });

    });

    if (<%= @is_wechat_browser %> == false
    )
    {
      $("#payment-form-submit").show();
      $('#btn_submit1').hide();
    }
    else
    {
      $("#payment-form-submit").hide();
      $('#btn_submit1').show();
    }

    if (typeof WeixinJSBridge == "undefined") {
      if (document.addEventListener) {
        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
      } else if (document.attachEvent) {
        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
      }
    } else {
      onBridgeReady();
    }

    function onBridgeReady() {
      if ("<%= @weixin_init_success %>" == "true") {
        $('#btn_submit1').off("click").on("click", function () {
          var url = "<%=campaign_ngo_confirmation_weixin_path%>";
//          var direct_donation = $("#direct_donation_input").val();
//          if(direct_donation.length<1)
//          {
//            direct_donation = $("#direct_donation").val();
//          }
//          if (direct_donation.length <= 0) {
//            alert("请输入捐款金额。");
//            return;
//          }

          $('#btn_submit1').prop('disabled', true);
          $.post(url, {direct_donation:1}).done(function (data, textStatus, jqXHR) {
            alert(data);
            if (data.error_msg != "") {
              alert(data.error_msg);
            } else {
              alert(data.order_id);
              weixin_load(data.order_id);
            }
          }).fail(function () {
            alert("请求已经结束但是可能发生了错误！");

            $('#btn_submit1').prop('disabled', false);
          }).always(function () {

          });
        });
      } else {
        alert("系统忙，请刷新页面再试。");
      }
    }
    
    function weixin_load(order_id) {
      alert(order_id);

      $.ajax({
          method: "get",
          url: "/weixin_payment_get_req/" + order_id,
          dataType: "json",
          cache: false,
          success: function (d) {
            alert(33333);
            alert(d);
            if (d) {
              alert("  "+ d.appId+"  "+ d.timeStamp+"  "+ d.nonceStr+"  "+ d.package+"  "+ d.paySign);
              WeixinJSBridge.invoke('getBrandWCPayRequest', {
                "appId": d.appId,     //公众号名称，由商户传入
                "timeStamp": d.timeStamp,         //时间戳，自1970年以来的秒数
                "nonceStr": d.nonceStr, //随机串
                "package": d.package,
                "signType": "MD5",         //微信签名方式:
                "paySign": d.paySign //微信签名
              }, function (res) {
                alert(res.err_msg);
                if (res.err_msg == "get_brand_wcpay_request:ok") {
                  ComfirmOrder(order_id);
                } else {
                  $('#wechat').prop('disabled', false);
                }
              });
            }
            else {
              $('#wechat').prop('disabled', false);
            }
          },
          error:function(XMLHttpRequest, textStatus, errorThrown) {
            alert(XMLHttpRequest.status);
            alert(XMLHttpRequest.readyState);
            alert(textStatus);
            $('#wechat').prop('disabled', false);
          },
          complete: function () {
            alert(1111);
          }
        });

    }

    function ComfirmOrder(order_id) {

      var order_make_anonymous = false;
      var fullName = $("#fullname").val();

      if (fullName == "") {
        fullName = "匿名";
        order_make_anonymous = true;
      }

      var avatar_url = $("#avatar_url").val();
      var order_time = new Date();
      var format_order_time = order_time.getFullYear() + "年" + (order_time.getMonth() + 1) + "月" + order_time.getDate() + "日 " + order_time.getHours() + ":" + order_time.getMinutes() + ":" + order_time.getSeconds();

      var data = {
        order_id: order_id,
        order_make_anonymous: order_make_anonymous,
        format_order_time: format_order_time,
        fullName: fullName,
        avatar_url: avatar_url
      };

      $.ajax('/ajax/update-order', {
        type: 'POST',
        data: data,
        beforeSend: function (jqXHR, settings) {
          jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
        },
        success: function (data) {

          window.location.href = "<%=campagin_ngo_lzds_path%>"
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          alert("抱歉，更新订单时出了问题，请联系我们帮您解决。");
        }
      });

    }

  });

  //限定输入框为数字
  $(function () {
    $.fn.numeral = function (bl) {//限制金额输入、兼容浏览器、屏蔽粘贴拖拽等
      $(this).keypress(function (e) {
        var keyCode = e.keyCode ? e.keyCode : e.which;
        if (bl) {//浮点数
          if ((this.value.length == 0 || this.value.indexOf(".") != -1) && keyCode == 46) return false;
          return keyCode >= 48 && keyCode <= 57 || keyCode == 46 || keyCode == 8;
        } else {//整数
          return keyCode >= 48 && keyCode <= 57 || keyCode == 8;
        }
      });
      $(this).bind("copy cut paste", function (e) { // 通过空格连续添加复制、剪切、粘贴事件
        if (window.clipboardData)//clipboardData.setData('text', clipboardData.getData('text').replace(/\D/g, ''));
          return !clipboardData.getData('text').match(/\D/);
        else
          event.preventDefault();
      });
      $(this).bind("dragenter", function () {
        return false;
      });
      $(this).css("ime-mode", "disabled");
      $(this).bind("focus", function () {
        if (this.value.lastIndexOf(".") == (this.value.length - 1)) {
          this.value = this.value.substr(0, this.value.length - 1);
        } else if (isNaN(this.value)) {
          this.value = "";
        }
      });
    }
    //调用文本框的id
    $("#direct_donation_input").numeral(true);
  });

  $(function () {

    $("#payment-form-submit").bind("click", function () {
//      if($("#direct_donation_input").val().length>0) {
//        $("#direct_donation").val($("#direct_donation_input").val());
//      }
//
//      if ($("#direct_donation").val().length<=0) {
//        alert("请输入捐款金额。");
//        return;
//      }

      $("#payment_form").submit();
    });
    $("#direct_donation_input").bind("blur", function () {
      if ($(this).val().length > 0) {
        $("#direct_donation").val("");

        $("#personal_modalbody a").each(function () {
          $(this).css('border', "1px solid #dddddd");
        });
      }
    });
    $("#personal_modalbody a").bind('click', function () {
      $("#direct_donation_input").val("");
      $("#direct_donation").val($(this).data("value"));
      $("#personal_modalbody a").each(function () {
        $(this).css('border', "1px solid #dddddd");
      });

      $(this).css('border', "solid 2px red");
    });
  });
</script>

<% if @sign_package %>
    <script>
      var campagin_share_link = "<%= campagin_ngo_lzds_url %>";
      window.shareData = {
        appid: "<%= ENV['WEIXIN_APPID'] %>",
        link: campagin_share_link,
        img_url: "<%= request.protocol + request.host_with_port + '/images/hongbao.jpg' %>",
        img_width: "415",
        img_height: "399",
        desc: "亲，就等你了。 1人1块钱拯救世界， 还能赢新年暖心红包...",
        title: "用红包拯救世界，你也来试试？"
      };

      wx.config({
        debug: false,
        appId: "<%= @sign_package['appId'] %>",
        timestamp: "<%= @sign_package['timestamp'] %>",
        nonceStr: "<%= @sign_package['nonceStr'] %>",
        signature: "<%= @sign_package['signature'] %>",
        jsApiList: [
          'onMenuShareTimeline',
          'onMenuShareAppMessage',
          'onMenuShareQQ',
          'onMenuShareWeibo'
        ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
      });

      wx.ready(function () {

        var title = shareData.title;
        var desc = shareData.desc;
        var link = shareData.link;
        var imgUrl = shareData.img_url

        wx.onMenuShareTimeline({
          title: title, // 分享标题
          desc: desc, // 分享描述
          link: link, // 分享链接
          imgUrl: imgUrl, // 分享图标
          trigger: function () {

          },
          success: function () {
            // 用户确认分享后执行的回调函数
            share_success();
          },
          cancel: function () {
            // 用户取消分享后执行的回调函数
          }
        });

        wx.onMenuShareAppMessage({
          title: title, // 分享标题
          desc: desc, // 分享描述
          link: link, // 分享链接
          imgUrl: imgUrl, // 分享图标
          // type: 'link', // 分享类型,music、video或link，不填默认为link
// 	    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
          trigger: function () {
          },
          success: function () {
            // 用户确认分享后执行的回调函数
            share_success();
          },
          cancel: function () {
            // 用户取消分享后执行的回调函数
          }
        });

        wx.onMenuShareQQ({
          title: title, // 分享标题
          desc: desc, // 分享描述
          link: link, // 分享链接
          imgUrl: imgUrl, // 分享图标
          trigger: function () {
          },
          success: function () {
            // 用户确认分享后执行的回调函数
            share_success();
          },
          cancel: function () {
            // 用户取消分享后执行的回调函数
          }
        });

        wx.onMenuShareWeibo({
          title: title, // 分享标题
          desc: desc, // 分享描述
          link: link, // 分享链接
          imgUrl: imgUrl, // 分享图标
          trigger: function () {
          },
          success: function () {
            // 用户确认分享后执行的回调函数
            share_success();
          },
          cancel: function () {
            // 用户取消分享后执行的回调函数
          }
        });

      });

      wx.error(function (res) {

        // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
        alert(res.errMsg);
      });

      $(function () {
        var shareid = $("#share_id").val();
        if (shareid.length == 0) {
          window.shareData.link = campagin_share_link;
        } else {
          window.shareData.link = campagin_share_link + '?id=' + shareid;
        }
      });
    </script>
<% end %>