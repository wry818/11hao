<div class="product_weixin_header">
  <p>
    <% if @campaign.minilogo %>
        <%= image_tag @campaign.minilogo%>
    <% else %>
        <%= image_tag "minilogo .png"%>
    <% end %>

    <span class="org_name"><%= @campaign.organization.name.length>14?@campaign.organization.name[0,13]+"..." :@campaign.organization.name%></span>  <span style="padding-left: 10px;">购买即捐赠</span>
  </p>

</div>
<div class="container product_pay">
  <div class="bd">
    <div id="btn-edit-address" class="weui_panel weui_panel_access ">
      <a href="javascript:void(0);" style="padding-right: 25px;" class="weui_media_box weui_media_appmsg weui_panel_ft">
        <div class="weui_media_hd" style="width: 20px; vertical-align: top;">
          <p>
            <img class="weui_media_appmsg_thumb" src="data:image/png;base64,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" alt="">
          </p>
        </div>
        <div id="address_weixin" class="weui_media_bd">
          <h4 class=\"weui_media_title\"> <span></span></h4>

          <p class=\"weui_media_desc\">点击选择收货地址 </p>
        </div>
      </a>
    </div>
    <div class="weui_panel weui_panel_access">
      <div class="weui_panel_hd">订单详情</div>
      <% @order.items.order(:id).each do |item| %>
          <a href="javascript:void(0);" class="weui_media_box weui_media_appmsg ">
            <div class="weui_media_hd">
              <p>
                <% photos=item.product.all_photo.all %>
                <% if (photos&&photos.length>0) %>
                    <%= cl_image_tag photos.first.public_id, width: 50, height: 50, crop: :fill,:class=>"weui_media_appmsg_thumb"%>
                <% end %>

              </p>
            </div>
            <div class="weui_media_bd">
              <h4 class="weui_media_title"><%= item.product.name %></h4>
              <% item.options.each do |option| %>
                  <% if option.value.present? %>
                      <p class="weui_media_desc"><%= "#{option.option_group.name}: #{option.value}" %></p>
                  <% end %>
              <% end %>
            </div>
            <div class="weui_media_lf" style="text-align: right;">
              <h4 class="weui_media_title" style="color:rgb(255, 102, 0);">￥<span><%= long_price(item.total_price/100.0) %></span></h4>

              <p class="weui_media_desc">×<%= item.quantity %></p>

            </div>
          </a>
      <% end %>
      <a href="javascript:void(0);" class="weui_media_box weui_media_appmsg ">
        <div class="weui_media_bd">
          <p class="weui_media_desc">运费：</p>
        </div>
        <div class="weui_media_lf">
          <p class="weui_media_desc"><span>￥0.00</span></p>
        </div>
      </a>

    </div>
    <div class="weui_panel">

      <div class="weui_media_box">
        <div class="weui_media_bd" style="text-align: center;">
          <p class="weui_media_title">
            ￥<%= long_price((@order.grandtotal-@order.direct_donation)/100.0) %> + ￥<%= long_price(@order.direct_donation/100.0) %>额外捐赠
          </p>
          <strong style="color:rgb(255, 102, 0);    font-size: 17px;font-weight: normal;">
            需付：￥<%= long_price(@order.grandtotal/100.0) %>
          </strong>
        </div>
      </div>
      <a href="javascript:void(0);" class="weui_media_box weui_media_appmsg ">
        <div class="weui_media_bd">
          <p class="weui_media_desc " style="text-align: center;">您的本次购买将为“<%=@campaign.organization.name%>”捐赠：<span>￥<%= long_price(@order_donation)%></span></p>
        </div>
      </a>
    </div>
    <div class="weui_panel">
      <div class="weui_panel_hd">
        <div id="wechat_weixin">
        <a href="javascript:;"  class="weui_btn weui_btn_primary">微信安全支付</a>
        </div>
      </div>
    </div>

    <%= render "goods_footer"%>
  </div>

</div>
<%= hidden_field_tag :fullname, @nickname %>
<%= hidden_field_tag :avatar_url, @avatar_url %>
<script>
    if (<%= Rails.env.test?||Rails.env.development? %>) {
      window._11hao.SetCurrentShippingAddress("闻人扬", "虹桥路12345号", "上海市", "上海市", "长宁区", "123456789", "200051");
    }else
    {
//      window._11hao.clearCurrentShippingAddress();
    }
    var currentShippingAddress = window._11hao.GetCurrentShippingAddress();
    if (currentShippingAddress != null) {
      var address = window._11hao.formatAddressNew();
      $("div#address_weixin").html(address);
    }


    if (document.addEventListener) {
      document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
    } else if (document.attachEvent) {
      document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
      document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
    }
    function onBridgeReady(){
      $("#btn-edit-address").click(function (event) {
        WeixinJSBridge.invoke('editAddress', {
          "appId": "<%= @app_id %>",
          "scope": "jsapi_address",
          "signType": "sha1",
          "addrSign": "<%= @addrSign %>",
          "timeStamp": "<%= @timestamp %>",
          "nonceStr": "<%= @nonceStr %>"
        }, function (res) {
          if (res && res.userName) {
            SaveAddress(res);
            // Raisy.alert("success");
            wechat_bind_click();
            window._11hao.loadingHidNNow();
          }
          else {
            if (res.err_msg != "edit_address:fail") {
              alert("系统忙，请稍候再试...");
              wechat_bind_click();
              window._11hao.loadingHidNNow();
            }
          }
        });
      });
      window._11hao.loadingShow();
      $("#btn-edit-address").click();
      if ("<%= @weixin_init_success %>" == "true") {

        $('#wechat_weixin').prop('disabled', false);

        if (<%= Rails.env.test? %>) {
        }
        else {
          window._11hao.clearCurrentShippingAddress();
        }
        function wechat_bind_click()
        {
//          alert(0);
          $('#wechat_weixin').one("click",function(){
             $(this).removeAttr("onclick");
              wechar_click();
          });
        }

       function wechar_click(){
          if ("<%= @order.needs_shipping %>" == "true") {
            var addr = window._11hao.GetCurrentShippingAddress();

            if (addr==null) {
              alert("请选择收货地址。");
              wechat_bind_click();
//              alert(addr);
              return;
            }
          }


          var $button=$(this);
          $button.attr('disabled', true);

          $.ajax({
              method: "get",
              url: "<%= weixin_payment_get_req_path @order %>",
              dataType: "json",
              cache: false,
              success: function (d) {
                window._11hao.loadingHidNNow();
                if (d && d.paySign!="") {
                  WeixinJSBridge.invoke('getBrandWCPayRequest', {
                    "appId" : d.appId,     //公众号名称，由商户传入
                    "timeStamp": d.timeStamp,         //时间戳，自1970年以来的秒数
                    "nonceStr" : d.nonceStr, //随机串
                    "package" : d.package,
                    "signType" : "MD5",         //微信签名方式:
                    "paySign" : d.paySign //微信签名
                  }, function(res) {
                    if(res.err_msg == "get_brand_wcpay_request:ok" ) {
//                      alert(res.err_msg);
                      ComfirmOrder();
                    } else {
//                      alert(1);
                      $button.attr('disabled', false);
                      wechat_bind_click();
                    }
                  });
                }
                else {
//                  alert(2);
                  $button.attr('disabled', false);
                  wechat_bind_click();
                }
              },
              error: function() {
                $button.attr('disabled', false);
                wechat_bind_click();
              },
              complete: function() {

              }
            });

        }

      } else {

        alert("系统忙，请刷新页面再试。");

      }
    }

    function SaveAddress(res) {

      window._11hao.SetCurrentShippingAddress(res.userName, res.addressDetailInfo, res.proviceFirstStageName, res.addressCitySecondStageName, res.addressCountiesThirdStageName, res.telNumber, res.addressPostalCode);
      var currentShippingAddress = window._11hao.GetCurrentShippingAddress();
      var address = window._11hao.formatAddress(currentShippingAddress.ProvinceName, currentShippingAddress.CityName, currentShippingAddress.CityAreaName, currentShippingAddress.AddressLine, currentShippingAddress.ReceiveName, currentShippingAddress.PhoneNumber);
      $("div#address_weixin").html(window._11hao.formatAddressNew());

      var order_make_anonymous = false;
      var fullName = $("#fullname").val();

      if (fullName == "") {
        fullName = "匿名";
        order_make_anonymous = true;
      }
      var avatar_url = $("#avatar_url").val();

      $.ajax('/ajax/update-order-address', {
        type: 'POST',
        data: {
          order_id: <%= @order.id %>,
          order_make_anonymous: order_make_anonymous,
          fullName: fullName,
          avatar_url: avatar_url,
          provinceName: currentShippingAddress.ProvinceName,
          cityName: currentShippingAddress.CityName,
          cityAreaName: currentShippingAddress.CityAreaName,
          addressLine: currentShippingAddress.AddressLine,
          receiveName: currentShippingAddress.ReceiveName,
          phoneNumber: currentShippingAddress.PhoneNumber,
          zipCode: currentShippingAddress.ZipCode
        },
        beforeSend: function (jqXHR, settings) {
          jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
        },
        success: function (data) {

        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {

        }
      });

    }

    function ComfirmOrder() {
//      alert(1111);
      var order_make_anonymous = false;
      var fullName = $("#fullname").val();

      if (fullName == "") {
        fullName = "匿名";
        order_make_anonymous = true;
      }

      var avatar_url = $("#avatar_url").val();

      var order_time = new Date();
      var format_order_time =  order_time.getFullYear() + "年" + (order_time.getMonth() + 1) + "月" + order_time.getDate() + "日 " + order_time.getHours() + ":" + order_time.getMinutes() + ":" + order_time.getSeconds();

//      alert(Validate());
      if (!Validate()) return;

      var data;

      if ("<%= @order.needs_shipping %>" == "true") {

        var currentShippingAddress = window._11hao.GetCurrentShippingAddress();

        data = {
          order_id: <%= @order.id %>,
          order_make_anonymous: order_make_anonymous,
          format_order_time: format_order_time,
          fullName: fullName,
          avatar_url: avatar_url,
          provinceName: currentShippingAddress.ProvinceName,
          cityName: currentShippingAddress.CityName,
          cityAreaName: currentShippingAddress.CityAreaName,
          addressLine: currentShippingAddress.AddressLine,
          receiveName: currentShippingAddress.ReceiveName,
          phoneNumber: currentShippingAddress.PhoneNumber,
          zipCode: currentShippingAddress.ZipCode
        };

      } else {

        data = {
          order_id: <%= @order.id %>,
          order_make_anonymous: order_make_anonymous,
          format_order_time: format_order_time,
          fullName: fullName,
          avatar_url: avatar_url
        };

      }
//      alert(data);
      $.ajax('/ajax/update-order', {
        type: 'POST',
        data: data,
        beforeSend: function (jqXHR, settings) {
          jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
        },
        success: function (data) {
          <% if @campaign.used_as_default? %>
          window.location.href = "/" + "<%= @campaign.slug %>" + "/checkout_support";
          <% else %>
          window.location.href = "/" + "<%= @campaign.slug %>" + "/confirmation_weixin";
          <% end %>
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          alert("抱歉，更新订单时出了问题，请联系我们帮您解决。");
        }
      });
    }

    function Validate() {

      var error = "";
      if ("<%= @order.needs_shipping %>" == "true") {
        var currentShippingAddress = window._11hao.GetCurrentShippingAddress();
        if (currentShippingAddress == null) {
          error += "\n";
          error += "请点击“常用地址”按钮选择收货地址。";
        }
      }
      if (error) {
        alert(error);
        return false;
      } else {
        return true;
      }
    }


</script>
<script>
  $(function(){
    $.ajax('/ajax/update-order-valid', {
      type: 'POST',
      data: {
        order_id: <%= @order.id %>
      },
      beforeSend: function (jqXHR, settings) {
        jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
      },
      success: function (data) {
        if(data!="success")
        {
            var local_url;
                  <% if @campaign.slug=="lb1001"%>
            local_url="/checkout/xyetjk";
                  <% elsif @campaign.slug=="lb1002"%>
            local_url="/checkout/lbxgy";
                  <% elsif @campaign.slug=="lb1003"%>
            local_url="/checkout/lbflower";
                  <%end%>
           window.location.href=local_url;
        }
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {

      }
    });
  });
</script>